{% extends 'hotel/base.html' %}

{% block titulo %}Hacer Reserva - Gestor Hotel{% endblock %}

{% block contenido %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-calendar-plus me-2"></i>Hacer Reserva
                </h4>
            </div>
            <div class="card-body">
                <!-- Información de la habitación ACTUALIZADA -->
                <div class="card bg-light mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            Habitación Seleccionada
                            {% if habitacion.esta_disponible %}
                                <span class="badge bg-success ms-2">
                                    <i class="fas fa-check me-1"></i>Disponible
                                </span>
                            {% else %}
                                <span class="badge bg-warning ms-2">
                                    <i class="fas fa-calendar me-1"></i>Con reservas
                                </span>
                            {% endif %}
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Número:</strong> {{ habitacion.numero }}</p>
                                <p class="mb-1"><strong>Tipo:</strong> {{ habitacion.tipo }}</p>
                                <p class="mb-1"><strong>Piso:</strong> {{ habitacion.piso }}</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Precio por noche:</strong> ${{ habitacion.tipo.precio_por_noche }}</p>
                                <p class="mb-1"><strong>Capacidad máxima:</strong> {{ habitacion.tipo.capacidad_maxima }} personas</p>
                                <p class="mb-1"><strong>Estado actual:</strong>
                                    <span class="badge {% if habitacion.estado == 'disponible' %}bg-success{% elif habitacion.estado == 'ocupada' %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ habitacion.get_estado_display }}
                                    </span>
                                </p>
                            </div>
                        </div>

                        {% if habitacion.descripcion %}
                            <p class="mt-3 mb-0 text-muted">{{ habitacion.descripcion }}</p>
                        {% endif %}

                        <!-- Mostrar próximas reservas si existen -->
                        {% if proximas_reservas %}
                            <div class="alert alert-info mt-3">
                                <h6><i class="fas fa-calendar-alt me-2"></i>Próximas Reservas de esta Habitación:</h6>
                                {% for reserva in proximas_reservas %}
                                    <div class="d-flex justify-content-between align-items-center border-bottom py-1">
                                        <span>
                                            <strong>{{ reserva.fecha_entrada|date:"d/m/Y" }} - {{ reserva.fecha_salida|date:"d/m/Y" }}</strong>
                                            <small class="text-muted">({{ reserva.calcular_noches }} noches)</small>
                                        </span>
                                        <span class="badge {% if reserva.estado == 'confirmada' %}bg-success{% elif reserva.estado == 'pendiente' %}bg-warning text-dark{% endif %}">
                                            {{ reserva.get_estado_display }}
                                        </span>
                                    </div>
                                {% endfor %}
                                <small class="text-muted mt-2 d-block">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    <strong>Importante:</strong> Asegúrate de seleccionar fechas que no conflicten con estas reservas.
                                </small>
                            </div>
                        {% else %}
                            <div class="alert alert-success mt-3">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>¡Excelente!</strong> Esta habitación no tiene reservas próximas. Puedes reservar cualquier fecha disponible.
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Formulario de reserva -->
                <form method="POST" id="reservaForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.fecha_entrada.id_for_label }}" class="form-label">
                                {{ form.fecha_entrada.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.fecha_entrada }}
                            <div class="form-text">La fecha debe ser hoy o posterior</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.fecha_salida.id_for_label }}" class="form-label">
                                {{ form.fecha_salida.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.fecha_salida }}
                            <div class="form-text">Debe ser posterior a la fecha de entrada</div>
                        </div>
                    </div>

                    <!-- Información de cálculo de precio -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card bg-light" id="calculoPrecio" style="display: none;">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-calculator me-2"></i>Cálculo de Precio
                                    </h6>
                                    <div id="detallesPrecio">
                                        <!-- Se llenará con JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.numero_huespedes.id_for_label }}" class="form-label">
                            {{ form.numero_huespedes.label }} <span class="text-danger">*</span>
                        </label>
                        {{ form.numero_huespedes }}
                        <div class="form-text">Máximo {{ habitacion.tipo.capacidad_maxima }} huéspedes para esta habitación</div>
                    </div>

                    <div class="mb-4">
                        <label for="{{ form.comentarios.id_for_label }}" class="form-label">
                            {{ form.comentarios.label }}
                        </label>
                        {{ form.comentarios }}
                        <div class="form-text">Solicitudes especiales, preferencias, etc. (opcional)</div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'lista_habitaciones' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Volver a Habitaciones
                        </a>
                        <button type="submit" class="btn btn-primary" id="btnConfirmar">
                            <i class="fas fa-check me-1"></i>Confirmar Reserva
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Información adicional -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Información de Reservas
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Estados de Reserva:</h6>
                        <ul class="list-unstyled">
                            <li><span class="badge bg-warning text-dark me-2">Pendiente</span> Tu reserva está en revisión</li>
                            <li><span class="badge bg-success me-2">Confirmada</span> Reserva aprobada y garantizada</li>
                            <li><span class="badge bg-danger me-2">Cancelada</span> Reserva cancelada</li>
                            <li><span class="badge bg-info me-2">Completada</span> Estadía finalizada</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Políticas del Hotel:</h6>
                        <ul class="small text-muted">
                            <li>Check-in: 15:00 hrs</li>
                            <li>Check-out: 12:00 hrs</li>
                            <li>Cancelación gratuita hasta 24h antes</li>
                            <li>Se requiere documento de identidad</li>
                        </ul>
                    </div>
                </div>
                <div class="alert alert-info mt-3">
                    <i class="fas fa-clock me-2"></i>
                    <strong>Proceso de Reserva:</strong> Tu reserva quedará en estado "Pendiente" hasta que un administrador la confirme.
                    Recibirás una notificación una vez que sea procesada.
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Calcular precio estimado y validaciones
    document.addEventListener('DOMContentLoaded', function() {
        const fechaEntrada = document.getElementById('id_fecha_entrada');
        const fechaSalida = document.getElementById('id_fecha_salida');
        const numeroHuespedes = document.getElementById('id_numero_huespedes');
        const precioPorNoche = '{{ habitacion.tipo.precio_por_noche }}';
        const capacidadMaxima = '{{ habitacion.tipo.capacidad_maxima }}';
        const calculoPrecio = document.getElementById('calculoPrecio');
        const detallesPrecio = document.getElementById('detallesPrecio');
        const btnConfirmar = document.getElementById('btnConfirmar');

        // Establecer fecha mínima como hoy
        const hoy = new Date().toISOString().split('T')[0];
        fechaEntrada.min = hoy;

        function validarFormulario() {
            let esValido = true;
            let mensajes = [];

            // Validar fechas
            if (fechaEntrada.value && fechaSalida.value) {
                const entrada = new Date(fechaEntrada.value);
                const salida = new Date(fechaSalida.value);

                if (entrada >= salida) {
                    esValido = false;
                    mensajes.push('La fecha de salida debe ser posterior a la entrada');
                }

                if (entrada < new Date(hoy)) {
                    esValido = false;
                    mensajes.push('La fecha de entrada no puede ser anterior a hoy');
                }
            }

            // Validar huéspedes
            if (numeroHuespedes.value) {
                const huespedes = parseInt(numeroHuespedes.value);
                if (huespedes > capacidadMaxima) {
                    esValido = false;
                    mensajes.push(`Esta habitación tiene capacidad máxima para ${capacidadMaxima} huéspedes`);
                }
                if (huespedes < 1) {
                    esValido = false;
                    mensajes.push('Debe haber al menos 1 huésped');
                }
            }

            // Actualizar botón
            btnConfirmar.disabled = !esValido;
            if (!esValido) {
                btnConfirmar.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Corrige los errores';
                btnConfirmar.className = 'btn btn-warning';
            } else {
                btnConfirmar.innerHTML = '<i class="fas fa-check me-1"></i>Confirmar Reserva';
                btnConfirmar.className = 'btn btn-primary';
            }

            return esValido;
        }

        function calcularPrecio() {
            if (fechaEntrada.value && fechaSalida.value) {
                const entrada = new Date(fechaEntrada.value);
                const salida = new Date(fechaSalida.value);
                const diferencia = salida.getTime() - entrada.getTime();
                const dias = Math.ceil(diferencia / (1000 * 3600 * 24));

                if (dias > 0) {
                    const total = dias * precioPorNoche;
                    const huespedes = numeroHuespedes.value || 1;

                    detallesPrecio.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Noches:</strong> ${dias}</p>
                                <p class="mb-1"><strong>Precio por noche:</strong> $${precioPorNoche.toLocaleString()}</p>
                                <p class="mb-1"><strong>Huéspedes:</strong> ${huespedes}</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Subtotal:</strong> $${(dias * precioPorNoche).toLocaleString()}</p>
                                <h5 class="text-primary"><strong>Total Estimado: $${total.toLocaleString()}</strong></h5>
                                <small class="text-muted">El precio final puede variar según políticas del hotel</small>
                            </div>
                        </div>
                    `;
                    calculoPrecio.style.display = 'block';
                } else {
                    calculoPrecio.style.display = 'none';
                }
            } else {
                calculoPrecio.style.display = 'none';
            }

            validarFormulario();
        }

        // Event listeners
        fechaEntrada.addEventListener('change', function() {
            // Actualizar fecha mínima de salida
            if (this.value) {
                const entrada = new Date(this.value);
                entrada.setDate(entrada.getDate() + 1);
                fechaSalida.min = entrada.toISOString().split('T')[0];
            }
            calcularPrecio();
        });

        fechaSalida.addEventListener('change', calcularPrecio);
        numeroHuespedes.addEventListener('change', calcularPrecio);
        numeroHuespedes.addEventListener('input', calcularPrecio);

        // Validación inicial
        validarFormulario();
    });
</script>
{% endblock %}